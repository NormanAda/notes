[TOC]

# 邮件收发过程

![](/home/spiko/notes/img/1120165-20171011215731184-1615174561.png)

1. 用户A的电子邮箱为：xx@qq.com，通过邮件客户端软件写好一封邮件，交到QQ的邮件服务器，这一步使用的协议是SMTP,对应图示的①；
2. QQ邮箱会根据用户A发送的邮件进行解析，也就是根据收件地址判断是否是自己管辖的账户，如果收件地址也是QQ邮箱，那么会直接存放到自己的存储空间。这里我们假设收件地址不是QQ邮箱，而是163邮箱，那么QQ邮箱就会将邮件转发到163邮箱服务器，转发使用的协议也是SMTP，对应图示的②；
3. 163邮箱服务器接收到QQ邮箱转发过来的邮件，也会判断收件地址是否是自己，发现是自己的账户，那么就会将QQ邮箱转发过来的邮件存放到自己的内部存储空间，对应图示的③；
4. 用户A将邮件发送了之后，就会通知用户B去指定的邮箱收取邮件。用户B会通过邮件客户端软件先向163邮箱服务器请求，要求收取自己的邮件，对应图示的④；
5. 163邮箱服务器收到用户B的请求后，会从自己的存储空间中取出B未收取的邮件，对应图示⑤；
6. 163邮箱服务器取出用户B未收取的邮件后，将邮件发给用户B，对应图示的⑥；
7. 最后三步用户B收取邮件的过程，使用的协议是POP3;

## 邮件服务器

- SMTP邮件服务器：替用户发送邮件和接收外面发送给本地用户的邮件，对应上图的第一、二步。它相当于现实生活中邮局的邮件接收部门（可接收普通用户要投出的邮件和其他邮局投递进来的邮件）。
- POP3/IMAP邮件服务器：帮助用户读取SMTP邮件服务器接收进来的邮件，对应上图的第六步。它相当于专门为前来取包裹的用户提供服务的部门。

## 邮件传输协议

- SMTP协议：全称为 Simple Mail Transfer Protocol，简单邮件传输协议。它定义了邮件客户端软件和SMTP邮件服务器之间，以及两台SMTP邮件服务器之间的通信规则。
- 全称为 Post Office Protocol，邮局协议。它定义了邮件客户端软件和POP3邮件服务器的通信规则。
- 全称为 Internet Message Access Protocol,Internet消息访问协议，它是对POP3协议的一种扩展，也是定义了邮件客户端软件和IMAP邮件服务器的通信规则。

# smtp和pop3协议

## SMTP协议发送邮件

SMTP 协议中一共定义了18条命令，但是发送一封电子邮件的过程通常只需要6条命令:

![](/home/spiko/notes/img/1120165-20171012205818918-1799542502.png)

1. 和SMTP服务器建立连接，telnet smtp.163.com 25。这条命令是和163邮箱建立连接

2. ehlo 发件人用户名，就是告诉SMTP服务器发送者的用户名。

3. 选择登录认证方式，一般在第二步执行完后，会提示有几种认证方式，一般选择的是login。即输入命令：auth login

4. 分别输入经过Base64加密后的用户名和密码。

5. 指明邮件的发送人和收件人

   　　　　mail from:<xxx@163.com>

   　　　　rcpt to:<xxx@qq.com>

6. 输入data命令，然后编写要发送的邮件内容，邮件的编写格式规则如下：

   　　　　第一步：输入data

   　　　　第二步：输入邮件内容　

   ```
   `from:<xxx``@163``.com>　　　　----邮件头发件人地址``to:<xxx``@qq``.com> 　　　　  ----邮件头收件人地址``subject:hello world　　　 ----邮件头主题``　　　　　　　　　　　　　　 -----空行``This is the first email sent by hand using the SMTP protocol　　　　　　　　　----邮件的具体内容`
   ```

7. 输入“.”表示邮件内容输入完毕
8. 输入quit命令断开与邮件服务器的连接

## 使用POP3协议手工接收邮件　

![](/home/spiko/notes/img/1120165-20171013233529668-98299246.png)

# 邮件的组织结构

## RFC822 邮件格式

RFC822 文档中定义的文件格式包括两个部分：邮件头和邮件体.

主要的邮件头字段的解释：

![](/home/spiko/notes/img/1120165-20171013234326574-1153565600.png)

FC822文档存在两个问题：

1. 定义了邮件内容的主体结构和各种邮件头字段的详细细节，但是，它没有定义邮件体的格式，RFC822文档定义的邮件体部分通常都只能用于表述一段普通的文本，而无法表达出图片、声音等二进制数据。
2. SMTP服务器在接收邮件内容时，当接收到只有一个“.”字符的单独行时，就会认为邮件内容已经结束，如果一封邮件正文中正好有内容仅为一个“.”字符的单独行，SMTP服务器就会丢弃掉该行后面的内容，从而导致信息丢失。

由于图片和声音等内容是非ASCII码的二进制数据，而RFC822邮件格式只适合用来表达纯文本的邮件内容，所以，要使用RFC822邮件格式发送这些非ASCII码的二进制数据时，必须先采用某种编码方式将它们“编码”成可打印的ASCII字符后再作为RFC822邮件格式的内容。邮件阅读程序在读取到这种经过编码处理的邮件后，再按照相应的解码方式解码出原始的二进制数据，这样就可以借助RFC822邮件格式来传递多媒体数据了。这种做法需要解决一下两个技术问题：

  1. 邮件阅读程序如何知道邮件中嵌入的原始二进制数据所采用的编码方式；

  2. 邮件阅读程序如何知道每个嵌入的图像或其他资源在整个邮件内容中的起止位置。

     

为了解决上面两个问题，人们后来专门为此定义了MIME（Multipurpose Internet Mail Extension，多用途Internet邮件扩展）协议。

## MIME协议

MIME协议用于定义复杂邮件体的格式，它可以表达多段平行的文本内容和非文本的邮件内容，例如，在邮件体中内嵌的图像数据和邮件附件等。另外，MIME协议的数据格式也可以避免邮件内容在传输过程中发生信息丢失。

MIME邮件在RFC822文档中定义的邮件头字段的基础上，扩充了一些自己专用的邮件头字段，例如，使用MIME-Version头字段指定MIME协议的版本，使用Content-Type头字段指定邮件体的MIME类型，使用Content-Transfer-Encoding头字段指定编码方法，如下所示： 　　　

```json
`MIME-Version:``1.0` `Content-Type:multipart/mixed;boundary=``"----=_NextPart_000_0050_01C"`
```

“multipart/mixed”部分说明邮件体中包含有多段数据，每段数据之间使用boundary属性中指定的字符文本作为分隔标识符。另外，MIME邮件也扩展了RFC822文档中已经定义了的邮件头字段的内涵，例如，定义了subject头字段中的值内容的格式，以便通过编码的方式让邮件主题中也可以使用非ASCII码的字符。subject头字段中的值嵌套在一对“=?”和“?=”标记符之间，标记符之间的内容由三部分组成：邮件主题的原始内容的字符集、当前采用的编码方式、编码后的结果.